name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mongo:
        image: mongo:6.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd="echo 'db.runCommand({ ping: 1 })' | mongosh localhost:27017/test --quiet"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set environment variable for MongoDB URI
      run: echo "MONGO_URI=mongodb://host.docker.internal:27017" >> $GITHUB_ENV

    - name: Start FastAPI with Docker Compose
      run: docker compose up -d --build

    - name: Wait for FastAPI to respond
      run: |
        echo "Waiting for FastAPI..."
        for i in {1..10}; do
          if curl -s http://localhost:8000/orders; then
            echo "✅ FastAPI is up"
            break
          else
            echo "⏳ FastAPI not ready... attempt $i"
            sleep 3
          fi
          if [ $i -eq 10 ]; then
            echo "❌ FastAPI did not start in time."
            docker logs fastapi
            exit 1
          fi
        done

    # Run tests inside Docker container (fixed command)
    - name: Run tests inside Docker container
      run: |
        docker exec fastapi bash -c "pip install -r /app/requirements.txt && pytest /app/tests/test_orders.py -v"

    - name: Shut down containers
      if: always()
      run: docker compose down
